## 동시성 (Concurrency) <-> 일관성,병렬성
- 어떤 두 사건이 같은 시간에 일어나는 것
- 대부분의 웹 서버는 여러개의 클라이언트 요청을 동시에 수행 할 수 있고, 이는 작성한 코드가 동시에 수행 될 수 있다는 의미이다.
https://zzang9ha.tistory.com/443

## 동시성 문제
-#데이터 일관성, 멀티스레드, 트랜잭션, 데드락
멀티 스레드 환경에서 동일한 자원에 대한 트랜잭션을 처리할 때, 데이터 일관성 테스트를 하던 중에 데드락이 발생
### 경쟁 상태(race condition)
- 공유 자원은 안정적인 접근과 제어가 되어야 하며 데이터 정합성을 지켜야 한다.
- 그러나 여러 프로세스 및 스레드가 `동시에 동일한 데이터(공유 자원)에 접근, 조작할 때 타이밍이나 접근 순서에 따라 예상했던 결과가 달라질 수 있는 상황`이 발생한다.
- 그렇기 때문에 특정 코드 블럭에서 한 번에 하나의 요청만을 처리할 수 있도록 제한하는 락(Lock)이 필요하다.

### 데드락(Deadlock)
### 기아(Starvation)

## 동시성 해결
https://velog.io/@yellowsunn/%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%9D%B4%EC%8A%88%EB%A5%BC-%ED%95%B4%EA%B2%B0%ED%95%98%EB%8A%94-%EB%8B%A4%EC%96%91%ED%95%9C-%EB%B0%A9%EB%B2%95
### 1.프로세스에서 Lock제어하기
#### 1.1. synchronized 키워드(동기화) 🤔
- 사용 : 메서드에 synchronized 키워드를 추가, 또는 코드 내부에 synchronized 블럭 추가
- 동일한 프로세스 내의 스레드 단위에서만 동시성을 보장한다. 
- 즉, 단일 서버라면 동시성 이슈가 발생하지 않지만 여러 대의 서버를 활용하면 동시성을 보장할 수 없다.
- synchronized 키워드는 메서드가 한 번에 하나의 스레드에서만 실행할 수 있도록 Locking
- 트랜잭션(@Transactional)과 동기화는 서로 다른 개념으로, 하나의 트랜잭션이 커밋되기 전에 다른 트랜잭션이 실행될 수 있어 동시성 이슈가 해결되지 않는다.

### 2.DB에서 Lock 제어하기
#### 2.1.비관적 락
#### 2.2.낙관적 락
### 3.Redis를 활용해 Lock 제어하기

## Lock 
1. 락이란?
https://velog.io/@fishphobiagg/MySQL-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B2%A9%EB%A6%AC-%EC%88%98%EC%A4%80-InnoDB-Locking



락이 왜 필요한가? : 동시성 문제가 있어서
동시성 문제는 왜 생기는가? 공유하는 데이터에 요러요청이 와서
비인기 콘서트에도 동시성이 필요한가? ㅇㅇ
그럼 분산락까지 필요한가?

제한된 자원에 다수의 유저가 경험하기 때문에 동시성제어가 필요함

redis의 성능은 싱글스레드에서 나오는게 아니다. in-memory라서 나오는 성능이다 (disk i/o가 덜하기 때문에)


redis를 보든 db를 보든 서버입장에서는 같은데 왜 분산락이 필요한가?
-> 서버 10대가 한 DB에 동시 요청하기 VS 서버 10대가 한 레디스에 동시요청하기
-DB:비쌈, 확장에 리소스가 큼
DB 자원을 아끼기 위해

레디스 : TLL을 설정할 수 잇고 락해제 못하게 되더라도 교착상태가 오래 지속되지 않는다
트랜잭션시간을 줄여야한다.

api : 유저의 요청을 서버가 받은 시간붜 오래 걸려야1초안에 처리되어야한다.
서버의 api처리 : 0.7~0.8초 사이에 이루어져야한다.
1초가 넘어가면 슬로우쿼리로 분류함(통계 분석용 쿼리가 아닌 이상)

각자의 서버시간이 모두 같지 않을 수 있다 (clock drift)
-합의 알고리즘(redlock)

분산 락에서도 데드락이 발생할 수있나요/?
-> master는 1개, slave(읽기전용)이 여러개

동시에 레디스에 락을 걸려고 하는 경우 : 락ㄱㅕㅇ합
레디스에서 경합이 발생하지 않는거지 lock경합 자체는 발생한다

서버->db 쿼리날리면 스레드를 점유한다
각 쿼리마다 스레드를 점유하는 것으로 알고잇음
서버에서의 스레드 점유 개수와 db요청 스레드의 개수가 같나?
->같을수도 잇고 다를수도 잇다
우리가 쓰는 스레드 : cpu상의 물리스레드가 아님

논리스레드
스프링 : request 1 : thread 1 mapping
db커넥션 기준으로는 아닐 수도 잇다
여러 요청을 멀티플렉싱해서 1개의 스레드에서 처리하는 기술

레디스가 싱글스레드에서 이다redis가 받은 요청을 처리하는걸 싱글스레드를 이용해서 하는 것
redis : disk i/o가은 작업들은 다른 스레드에서 한다 (유사 webflux)

싱글스레드(내부동작은 멀티스레드인 경우가 잇음) vs 멀티스레드 
blocking io가 일반적임
성능을 위해 이벤트루프가 도입하고 비동기 처리를 위임하는 것

어떤 부분이 싱글스레드에서 냐가 중요
