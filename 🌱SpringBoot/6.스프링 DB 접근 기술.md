스프링 데이터 액세스
- H2 데이터베이스 설치
- 순수 JDBC
- 스프링 JDBCTemplate
- JPA
- 스프링 데이터 JPA

### 1. H2 데이터베이스 설치
 개발이나 테스트 용도로 가볍고 편리한 DB, 웹화면 제공
 - [https://www.h2database.com]
 - 다운로드 및 설치
 - h2 데이터베이스 버전은 스프링 부트 버전에 맞춘다.
 - 데이터베이스 파일 생성 방법
	 - JDBC URL : `jdbc:h2:~/test`(최초 한번)
	 - `~/test.mv.db`파일 생성 확인 (home에 있음)
	 - 이후부터는 JDBC URL: `jdbc:h2:tcp://localhost/~/test`로 접근
		 - 최초 접근한 경로로 접근하면 애플리케이션, 웹 콘솔이 같이 접근이 안될 수 있음.

- H2 데이터베이스가 정상 생성되지 않을때
	- H2 데이터베이스를 종료하고 다시 시작.
	- 웹 브라우저가 자동 실행되면 주소창의 맨 앞 ip를 `localhost`로 변경
	- 데이터베이스 파일을 생성하면(`jdbc:h2:~/test`) 데이터베이스가 정상 생성된다.

- 테이블 생성
```
DROP TABLE IF EXISTS member CASCADE;
CREATE TABLE member (
	id bigint generated by default as identity,
	name varchar(255),
	primary key(id)
);
```

***

### 2.순수 JDBCTemplate 
>주의! 현재는 사용하지 않으니 참고만 할 것.

**환경설정**
- build.gardle파일(dependencies 구)에 jdbc, h2 데이터베이스 관련 라이브러리 추가
- 자바는 jdbc가 있어야 DB와 붙을 수 있음.
```
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```

- 스프링 부트 데이터베이스 연결 설정 추가
- `resources/application.properties` 파일에 아래 구문 추
```
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
```


**Jdbc 리포지토리 구현**
- 기존의 Member Repository는 인터페이스이고, MemoryMemberRepository는 메모리에 저장하는 구현체 였음.,
- 새 리포지토리를 만들어서 구현체를 변경해줌

> 인터페이스 : 회원 저장 역할 (MemoryMemberRepository)
> 구현제 : 인터페이스의 역할을 실제 구현하는 역할(MemoryMemberRepository:메모리에/JdbcMemberRepository:DB에)

- DB를 사용하려면 리포지토리에 DataSource가 있어야함
- `application.propertie`에 작성해둔 내용으로 Spring Boot로 부터 DataSource를 주입받음.
```
import javax.sql.DataSource;

...

private final DataSource dataSource;  

//스프링에 의해 주입받음
public JdbcMemberRepository(DataSource dataSource) {  
    this.dataSource = dataSource;  
}
```

- DataSource를 `SpringConfig`로 옮기기
- DataSource 는 데이터베이스 커넥션을 획득할 떄 사용하는 객체.
- Spring Boot는 데이터베이스 커넥션 정보를 바탕으로 DataSource를 생성하고 스프링 빈으로 만들어두어 DI를 받을 수 있다.
```
package grace.firstspring;  
  
import grace.firstspring.repository.MemberRepository;  
import grace.firstspring.repository.MemoryMemberRepository;  
import grace.firstspring.service.MemberService;  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.context.annotation.Bean;  
import org.springframework.context.annotation.Configuration;  
  
import javax.sql.DataSource;  
  
@Configuration  
public class SpringConfig {  
  
    private DataSource dataSource;  
  
    @Autowired  
    public SpringConfig(DataSource dataSource) {  
        this.dataSource = dataSource;  
    }  
  
  
    @Bean  
    public MemberService memberService(){  
        return new MemberService(memberRepository());  
    }  
  
    @Bean  
    public MemberRepository memberRepository(){  
        return new MemoryMemberRepository();  
    }  
}
```

**구현 클래스 추가 이미지**
![[Pasted image 20231217134032.png]]
- MemberService가 MemberRepository를 의존하고 있고 레파지토리는 구현체로 MemoryMemberRepository와 JdbcMemberRepository가 있다.


**스프링 설정 이미지**
![[Pasted image 20231217134206.png]]
- 개방/폐쇄 원칙(OCP, Open-Closed Principle)
	- 확장에는 열려있고, 수정변경에는 닫혀있다.
	- SOLID의 한 종류?
- 스프링의 DI(Dependencies Injection)을 사용하면 *기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경* 할 수 있다.
- 회원을 등록하고 DB에 결과가 잘 입력되는지 확인하자.
- 데이터를 DB에 저장하므로 스프링 서버를 다시 실행해도 데이터가 안전하게 저장된다.


### 3.스프링 통합 테스트
- `@SpringBootTest` : 스프링 컨테이너와 테스트를 함께 실행한다.
- `@Transactional` : 테스트 케이스에 붙이면, 테스트 시작 전에 트랜잭션을 시작하고, 완료 후에 항상 롤백한다. 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않는다!(테스트케이스에 사용했을때)

>참고
>순수한 단위 테스트가 통합테스트 보다 좋은 테스트일 확률이 높다. 스프링 컨테이너 없이 테스트 할 수 있도록 훈련해야 한다. 속도 차이도 꽤 나기 때문..

***

### 4.스프링 JDBCTemplate 
- 순수 jdbc와 동일한 환경설정을 하면 된다.
- 스프링 jdbcTemplate과 MyBatis 같은 라이브러리는JDBC API에서 본 반복 코드를 대부분 제거해준다. 하지만 SQL은 직접 작성해야 한다.